<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BomberMupp!</title>
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>
    <script type="text/javascript" src="input.js" defer></script>
    <script type="text/javascript" src="draw.js" defer></script>
  </head>
  <body> 
    <div id="main">
      <h1>BomberMupp</h1>
      <section id="rooms">
        <h2>Create a new room</h2>
        <form class="form-create">
          <div><label for="playerNumber">Max players:</label><input id="playerNumber" name="playerNumber" type="number" value="2" min="2" max="4" step="1"/></div>
          <div><label for="public">Anyone can join?</label><input id="public" name="public" type="checkbox"/></div>
          <div><label for="map">Map:</label><select id="map" name="map"></select></div>
          <button onclick="sendCreate(); return false;">Create game</button>
        </form>
        <hr>
        <h2>Join an existing room</h2>
      </section>
      <section id="waiting">
        <p>
          <div>Players: <span id="currentPlayers"></span>/<span id="maxPlayers"></span></div>
          <div>Room link: <span id="roomLink"></span></iv>
        </p>
      <section>
      <section id="game">
        <canvas id="bomber" width="550px" height="550px"></canvas>
        <p>Controls:<p>
        <dl>
          <dt>[arrow keys]</dt><dd>Player Blue / Red / Green / Yellow: Up/left/down/right </dd>
          <dt>space</dt><dd>Player Blue / Red / Green / Yellow: Bomb</dd>
        </dl>
      </section>
    </div>
  </body>
  <script>
    var socket = io.connect("http://"+document.domain+":9501");
    var currentToken;
    socket.on("connect", function(){
      console.log("Connected to server");
      var tok = window.location.search.substring(1);
      if(tok){
        console.log("Joining token "+tok);
        socket.emit("join-game", {token: tok});
      }
    });
    socket.on("maps", function(data){
      console.log("Recieved maps!");
      var mapData = data.mapData;
      for(var i = 0; i<mapData.length; i++){
        var name = mapData[i].name;
        var preview = mapData[i].tiles;
        $("#map").append($("<option></option>").val(i).html(name));
      }
    });
    function sendCreate(){
      var players = $("#playerNumber").val();
      var public = $("#public").attr('checked') ? true : false;
      var map = $("#map").val();
      socket.emit("create-game", {players: players, public: public, map: map});
    }
    socket.on("create-game-error", function(data){
      alert(data.msg);
    });
    socket.on("join-error", function(data){
      alert(data.msg);
    });
    socket.on("room-closed", function(data){
      alert(data.msg);
      window.history.pushState({}, "BomberMupp", "http://"+document.domain+":9501");
      currentToken = null;
      showReg();
    });
    socket.on("join", function(data){
      currentToken = data.token;
      console.log("Joined", currentToken);
      showWait();
      if(data.admin){
        displayAdmin(true);
      }
      window.history.pushState({}, "BomberMupp", "http://"+document.domain+":9501?"+currentToken);
    });
    socket.on("game-info", function(data){
      var token = data.token;
      if(token == currentToken){
        $("#roomLink").text("http://"+document.domain+":9501?"+token);
        $("#currentPlayers").text(data.players);
        $("#maxPlayers").text(data.max);
      } else {
        console.log("Got info for token "+token);
      }
    });

    function displayAdmin(val){
    }


    function showWait(){
      $("#rooms").hide();
      $("#waiting").show();
      $("#game").hide();
      display(false);
    }

    function showReg(){
      $("#rooms").show();
      $("#waiting").hide();
      $("#game").hide();
      displayAdmin(false);
    }
  </script>
</html>
